/*!
\file
\brief Класс, описывающий полином Crc64 для расчета контрольной суммы пакетов
\author V-Nezlo (vlladimirka@gmail.com)
\date 23.09.2025
\version 2.0

*/

#ifndef LIB_CRC64_HPP_
#define LIB_CRC64_HPP_

#include <cstddef>
#include <cstdint>

class Crc64 {
	Crc64() = delete;
	Crc64(const Crc64 &) = delete;
	Crc64 &operator=(const Crc64 &) = delete;

	static constexpr uint64_t table[]
		= {0x0000000000000000ULL, 0x42F0E1EBA9EA3693ULL, 0x85E1C3D753D46D26ULL, 0xC711223CFA3E5BB5ULL,
			0x4933F7ACB3C81A59ULL, 0x0BC316473A223CCBULL, 0xCCD2327BE01C774FULL, 0x8E22D39049F641DCULL,
			0x9267EF59672734B3ULL, 0xD0970EB2CECD0220ULL, 0x17862C8E94F959A6ULL, 0x5576CD653D136F35ULL,
			0xDB5418A2E4EF2EEAULL, 0x99A4F9494D051879ULL, 0x5EB5DB75173B43FDULL, 0x1C453A9EBED1756EULL,
			0x668842B2B1868D55ULL, 0x2478A359186CBBE6ULL, 0xE369816542528060ULL, 0xA199608EEBB8B6F3ULL,
			0x2FBBB51E0B7A970FULL, 0x6D4B54F5A290A19CULL, 0xAA5A76C9F8AEFA1AULL, 0xE8AA97225144CC89ULL,
			0xF4EFABEB36A1B9E6ULL, 0xB61F4A009F4B8F75ULL, 0x710E683CC575D4F1ULL, 0x33FE89D76C9FE262ULL,
			0xBDDC5C478C6DC39EULL, 0xFF2CBDAE2587F50DULL, 0x383D9F927FB9AE8BULL, 0x7ACD7E79D6539818ULL,
			0xCD1050E7AC8D2FAAULL, 0x8FE0B10C05671939ULL, 0x48F193305F5932BDULL, 0x0A0172DBF6B3042EULL,
			0x8423A74B166125D2ULL, 0xC6D346A0BF8B1341ULL, 0x01C2649CE5B548C7ULL, 0x433285774C5F7E54ULL,
			0x5F77B9BE2BBA0B3BULL, 0x1D87585582103DA8ULL, 0xDA967A69D82E662EULL, 0x98669B8271C450BDULL,
			0x16444E1291267141ULL, 0x54B4AFF938CC47D2ULL, 0x93A58DC562F21C56ULL, 0xD1556C2ECB181AC5ULL,
			0xAB0B1451C30BA2FEULL, 0xE9FBF5BA6AE1946DULL, 0x2EEAD78630DFCFE9ULL, 0x6C1A366D9935F97AULL,
			0xE238E3FD79F7D886ULL, 0xA0C80216D01DEE15ULL, 0x67D9202A8A23B591ULL, 0x2529C1C123C98302ULL,
			0x396CFD08A42CF66DULL, 0x7B9C1CE30DC6C0FEULL, 0xBC8D3EDF57F89B7AULL, 0xFE7DDF34FE12ADE9ULL,
			0x705F0AA41ED08C15ULL, 0x32AFEB4FB73ABA86ULL, 0xF5BEC973ED049102ULL, 0xB74E289844EE8791ULL,
			0x9A20A0D1591A5F54ULL, 0xD8D0413AF0F069C7ULL, 0x1FC16306AACE3241ULL, 0x5D3182ED032404D2ULL,
			0xD313577DE3E6252EULL, 0x91E3B6964A0C13BDULL, 0x56F294AA10324839ULL, 0x14027541B9D87EAAULL,
			0x08474988DE3D0BC5ULL, 0x4AB7A86377D73D56ULL, 0x8DA68A5F2DE966D0ULL, 0xCF566BB484035043ULL,
			0x4174BE2464C171BFULL, 0x03845FCFCD2B472CULL, 0xC4957DF397152CA8ULL, 0x86659C183EFF1A3BULL,
			0xFC3BE42436EC8210ULL, 0xBECB05CF9F06B483ULL, 0x79DA27F3C538EF07ULL, 0x3B2AC6186CD2D994ULL,
			0xB50813888C10F868ULL, 0xF7F8F26325FACEFBULL, 0x30E9D05F7FC4957DULL, 0x721931B4D62EA3EEULL,
			0x6E5C0D7DB1CBD681ULL, 0x2CACEC961821E012ULL, 0xEBBDCEAA421FBB96ULL, 0xA94D2F41EBF58D05ULL,
			0x276FFAD10B37ACF9ULL, 0x659F1B3AA2DD9A6AULL, 0xA28E3906F8E3C1EEULL, 0xE07ED8ED5109F77DULL,
			0x57A3F6732BD745CFULL, 0x15531798823D735CULL, 0xD24235A4D80328D8ULL, 0x90B2D44F71E91E4BULL,
			0x1E9001DF912B3FB7ULL, 0x5C60E03438C10924ULL, 0x9B71C20862FF52A0ULL, 0xD98123E3CB156433ULL,
			0xC5C41F2AACF0115CULL, 0x8734FEC1051A27CFULL, 0x4025DCFD5F247C4BULL, 0x02D53D16F6CE4AD8ULL,
			0x8CF7E886160C6B24ULL, 0xCE07096DBFE65DB7ULL, 0x09162B51E5D80631ULL, 0x4BE6CABA4C3230A2ULL,
			0x31B8B286440CA899ULL, 0x7348536DED50E0AULL, 0xF0597151B77E25CEULL, 0xB2A990BA1E94135DULL,
			0x3C8B452AFE5632A1ULL, 0x7E7BA4C157BC0432ULL, 0xB96A86FD0D825FB6ULL, 0xFB9A6716A4686925ULL,
			0xE7DF5BDFC38D1C4AULL, 0xA52FBA346A672AD9ULL, 0x623E98083059715DULL, 0x20CE79E399B347CEULL,
			0xAEECAC4279716632ULL, 0xEC1C4DA9D09B50A1ULL, 0x2B0D6F958AA50B25ULL, 0x69FD8E7E234F3DB6ULL,
			0xF420A0E05991CF04ULL, 0xB6D0410BF07BF997ULL, 0x71C16337AA45A213ULL, 0x333182DC03AF9480ULL,
			0xBD13574CE36DB57CULL, 0xFFE3B6A74A8783EFULL, 0x38F2949B10B9D86BULL, 0x7A027570B953EEF8ULL,
			0x664769B9DEB69B97ULL, 0x24B78852775CAD04ULL, 0xE3A6AA6E2D62F680ULL, 0xA1564B858488C013ULL,
			0x2F749E15644AE1EFULL, 0x6D847FFE0DA0D77CULL, 0xAA955DC2579E8CF8ULL, 0xE865BC29FE74BA6BULL,
			0x923BC415F6672250ULL, 0xD0CB25FE5F8D14C3ULL, 0x17DA07C205B34F47ULL, 0x552AE629AC5939D4ULL,
			0xDB0833B94C9B1828ULL, 0x99F8D252E5712EBBULL, 0x5EE9F06EBF4F753FULL, 0x1C19118516A543ACULL,
			0x005C2D4C714036C3ULL, 0x42ACCCA7D8AA0050ULL, 0x85BDEE9822945BD4ULL, 0xC74D0F738B7E6D47ULL,
			0x496FDAE36BBC4CBBULL, 0x0B9F3B08C2567A28ULL, 0xCC8E1934986821ACULL, 0x8E7EF8DF3182173FULL,
			0x39A3D6414B5CA58DULL, 0x7B5337AAE2B6931EULL, 0xBC421596B888C89AULL, 0xFEB2F47D1162FE09ULL,
			0x709021EDF1A0DFF5ULL, 0x3260C0065810E966ULL, 0xF571E23A022EB2E2ULL, 0xB78103D1ABC48471ULL,
			0xABC43F18CC21F11EULL, 0xE934DEF365CBF78DULL, 0x2E25FCCF3FF5AC09ULL, 0x6CD51D24961F9A9AULL,
			0xE2F7C8B476DD8866ULL, 0xA007295FDF37BEF5ULL, 0x67160B638509E571ULL, 0x25E6EA882CE3D3E2ULL,
			0x5FB892B424F04BD9ULL, 0x1D48735F8D1A7D4AULL, 0xDA595163D72426CEULL, 0x98A9B0887ECE105DULL,
			0x168B65189E0C31A1ULL, 0x547B84F337E60732ULL, 0x936AA6CF6DD85CB6ULL, 0xD19A4724C4326A25ULL,
			0xCDDF7BEDAFD71F4AULL, 0x8F2F9A06063D29D9ULL, 0x483EB83A5C03725DULL, 0x0ACE59D1F5E944CEULL,
			0x84EC8C41152B6532ULL, 0xC61C4DAAACC153A1ULL, 0x010D6F96F6FF0825ULL, 0x43FD8E7D5F153EB6ULL,
			0xD420A0E325C9CC04ULL, 0x96D041088C23FA97ULL, 0x51C16334D61DA113ULL, 0x133182DF7FF79780ULL,
			0x9D31574F9F35B67CULL, 0xDFC1B6A436DF80EFULL, 0x18D094986CE1DB6BULL, 0x5A207573C50BEDF8ULL,
			0x466549BAACEE9897ULL, 0x0495A8510524AE04ULL, 0xC3848A6D5F1AF580ULL, 0x81746B86F6F0C313ULL,
			0x0F56BE161632E2EFULL, 0x4DA65FFD5FD8D47CULL, 0x8AB77DC105E68FF8ULL, 0xC8479C2AAC0CB96BULL,
			0xB219E416A41F21F0ULL, 0xF0E905FD0DF51763ULL, 0x37F827C157CB4CE7ULL, 0x7508C62AFE217A74ULL,
			0xFB2A13BA1EE35B88ULL, 0xB9DAF251B7096D1BULL, 0x7ECBD06DED37369FULL, 0x3C3B318644DD000CULL,
			0x207E0D4F23387563ULL, 0x628EECA48AD243F0ULL, 0xA59FCE98D0EC1874ULL, 0xE76F2F7379062EE7ULL,
			0x694DFAE399C40F1BULL, 0x2BBD1B08302E3988ULL, 0xECAC39346A10620CULL, 0xAE5CD8DFC3FA549FULL,
			0x1981F641B924E62DULL, 0x5B7117AA10CED0BEULL, 0x9C6035964AF08B3AULL, 0xDE90D47DE31ABDA9ULL,
			0x50B201ED03D89C55ULL, 0x1242E006AA32AAC6ULL, 0xD553C23AF00CF142ULL, 0x97A323D159E6C7D1ULL,
			0x8BE61F183E03B2BEULL, 0xC916FEF397E9842DULL, 0x0E07DCCFCDD7DFA9ULL, 0x4CF73D24643DE93AULL,
			0xC2D5E8B484FF84C6ULL, 0x8025095F2D15B255ULL, 0x47342B63772BE9D1ULL, 0x05C4CA88DEC1DF42ULL,
			0x7F9AB2B4D6D24779ULL, 0x3D6A535F7F3871EAULL, 0xFA7B716325063A6EULL, 0xB88B90888CEC0CFDULL,
			0x36A945186C2E2D01ULL, 0x7459A4F3C5C41B92ULL, 0xB34886CF9FFA4016ULL, 0xF1B86724361076A5ULL,
			0xEDFD5BED51F503CAULL, 0xAF0DBA06F81F3559ULL, 0x681C983AA2216EDDULL, 0x2AEC79D10BCB584EULL,
			0xA4CEAC41EB0979B2ULL, 0xE63E4DAA42E34F21ULL, 0x212F6F9618DD14A5ULL, 0x63DF8E7DB1372236ULL};

public:
	///
	/// \brief Рассчитывает CRC64 для буфера
	/// \param aData указатель на буфер с данными
	/// \param aLength длина буфера с данными
	/// \return Рассчитанный CRC64
	///
	static uint64_t calculate(const void *aData, size_t aLength)
	{
		uint64_t calculated = 0;
		const uint8_t *data = static_cast<const uint8_t *>(aData);

		while (aLength--) { calculated = table[(calculated ^ *data++) & 0xFF] ^ (calculated >> 8); }

		return calculated;
	}

	///
	/// \brief Функция для расчета CRC64 для принимаемых сообщений
	/// \param aChecksum текущая контрольная сумма
	/// \param aBuffer указатель на буфер с данными
	/// \param aLength размер буфера
	/// \return Рассчитанный CRC64
	///
	static uint64_t update(uint64_t aChecksum, const void *aBuffer, size_t aLength)
	{
		const uint8_t *buffer = static_cast<const uint8_t *>(aBuffer);
		constexpr uint64_t polynomial = 0x42F0E1EBA9EA3693ULL;

		while (aLength--) {
			uint8_t value = *buffer++;
			for (uint8_t bit = 0; bit < 8; ++bit) {
				if ((aChecksum ^ value) & 0x01) {
					aChecksum = (aChecksum >> 1) ^ polynomial;
				} else {
					aChecksum >>= 1;
				}
				value >>= 1;
			}
		}

		return aChecksum;
	}
};

constexpr uint64_t Crc64::table[];

#endif // LIB_CRC64_HPP_
